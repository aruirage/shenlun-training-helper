<!-- pages/memory/index.wxml -->
<view class="page">

  <!-- å·¦ä¾§å¯¼èˆªï¼ˆä»… Pad æ˜¾ç¤ºï¼‰ -->
  <view class="sidebar" wx:if="{{isPad}}">
    <view class="logo-wrap">
      <text class="logo-main">ç¬”æ†å­DIY</text>
    </view>

    <view class="nav-list">
      <view 
        wx:for="{{navItems}}" 
        wx:key="name"
        class="nav-item {{activeNav === item.name ? 'nav-active' : ''}}"
        data-name="{{item.name}}"
        data-route="{{item.route}}"
        bindtap="onNavItemTap"
      >
        <text class="nav-icon">{{item.icon}}</text>
        <text class="nav-text">{{item.name}}</text>
      </view>
    </view>

    <view class="user-box" bindtap="goToMe">
      <view class="avatar"></view>
      <text class="user-name">ç”¨æˆ·åç§°</text>
    </view>
  </view>

  <!-- ä¸»åŒºåŸŸ -->
  <view class="main">
    <view class="main-content">
      <!-- é¡¶éƒ¨æ¨¡å¼æ¡ -->
      <view class="topbar">
      <view class="mode-group">
        <view class="mode-btn {{viewMode === 'study' ? 'mode-active' : ''}}" data-mode="study" bindtap="switchViewMode">
          <text class="mode-icon">ğŸ“š</text>
          <text class="mode-text">èƒŒè¯µæ¨¡å¼</text>
        </view>
        <view class="mode-btn {{viewMode === 'quiz' ? 'mode-active-quiz' : ''}}" data-mode="quiz" bindtap="switchViewMode">
          <text class="mode-icon">ğŸ§ª</text>
          <text class="mode-text">æµ‹éªŒæ¨¡å¼</text>
        </view>
      </view>

      <view class="topbar-right">
        <view class="status-box">
          <text class="status-label">STATUS</text>
          <text class="status-value">
            {{viewMode === 'study' ? 'ä»Šæ—¥å¾…å¤ä¹ ' : 'æœ¬è½®å¾…æµ‹éªŒ'}}ï¼š{{pendingCount}}
          </text>
        </view>
        <view class="settings-btn" bindtap="toggleSettings">âš™ï¸</view>
      </view>
    </view>

    <!-- å¡ç‰‡åŒºåŸŸ -->
    <view class="card-wrapper">
      <block wx:if="{{currentMaterial}}">
        <view class="flip-container {{isFlipped ? 'flipped' : ''}}" bindtap="toggleFlip">
          <view class="flipper">

            <!-- æ­£é¢ -->
            <view class="card-face card-front {{viewMode === 'quiz' ? 'front-quiz' : ''}}">
              <view class="card-header">
                <view class="tag-group">
                  <view class="tag-chip">{{currentMaterial.type}}</view>
                  <text class="field-chip">{{currentMaterial.field}}</text>
                </view>

                <!-- æ–°å¢ï¼špeek å°çœ¼ç› -->
                    <view wx:if="{{viewMode === 'study'}}"
                      class="peek-btn {{isPeek ? 'peek-active' : ''}}"
                      catchtap="togglePeek">
                  <text wx:if="{{!isPeek}}">ğŸ‘ï¸â€ğŸ—¨ï¸</text>
                  <text wx:else>ğŸ‘ï¸</text>
                </view>
              </view>

              <view class="card-body">
                <block wx:if="{{viewMode === 'quiz'}}">
                  <view class="quiz-center">
                    <view class="quiz-icon">?</view>
                    <text class="quiz-text">è¯·å°è¯•é»˜å†™æˆ–å£è¿°å®Œæ•´å¥å­</text>
                    <view class="hint-pill">
                      <text class="hint-label">æç¤ºå…³é”®è¯ï¼š</text>
                      <view class="hint-keys">
                        <text class="hint-key" wx:for="{{currentMaterial.keywords}}" wx:key="*this">
                          {{item}}
                        </text>
                      </view>
                    </view>
                  </view>
                </block>

                <block wx:else>
                  <view class="quote-line">
                    <text class="quote-mark">â€œ</text>
                    <block wx:for="{{displayParts}}" wx:key="index">
                      <text wx:if="{{!item.isKeyword}}" class="normal-text">{{item.text}}</text>
                      <view wx:else class="keyword-wrapper" catchtouchstart="startPeek" catchtouchend="endPeek">
                        <text class="keyword-text {{isFlipped || isPeek ? 'kw-visible' : 'kw-hidden'}}">{{item.text}}</text>
                        <view wx:if="{{!(isFlipped || isPeek)}}" class="keyword-mask"></view>
                      </view>
                    </block>
                    <text class="quote-mark">â€</text>
                  </view>
                </block>
              </view>

              <view class="card-footer">
                <text class="tip-text">
                  {{viewMode === 'study' ? 'è½»ç‚¹å¡ç‰‡æŸ¥çœ‹å®Œæ•´å†…å®¹ï¼Œé•¿æŒ‰å°çœ¼ç›å¯å·çœ‹å…³é”®è¯' : 'è½»ç‚¹å¡ç‰‡æŸ¥çœ‹æ­£ç¡®ç­”æ¡ˆ'}}
                </text>
              </view>
            </view>

            <!-- èƒŒé¢ -->
            <view class="card-face card-back">
              <scroll-view scroll-y="true" class="back-scroll">
                <view class="back-section">
                  <text class="section-label">å®Œæ•´åŸå¥</text>
                  <text class="section-full">â€œ{{currentMaterial.content}}â€</text>
                </view>

                <block wx:if="{{viewMode === 'study'}}">
                  <view class="back-section">
                    <text class="section-label">æ ¸å¿ƒé‡Šä¹‰</text>
                    <text class="section-content">{{currentMaterial.meaning}}</text>
                  </view>

                  <view class="back-section">
                    <text class="section-label">å¥æ³•æ‹†è§£</text>
                    <view class="structure-box">
                      <text class="structure-text">{{currentMaterial.structure}}</text>
                    </view>
                  </view>

                  <view class="back-section">
                    <text class="section-usage">ğŸ’¡ {{currentMaterial.usageTip}}</text>
                  </view>
                </block>

                <block wx:else>
                  <view class="back-section">
                    <text class="section-label">è‡ªæµ‹æé†’</text>
                    <text class="section-content">
                      æ³¨æ„å…³é”®è¯ï¼š
                      <text class="section-highlight" wx:for="{{currentMaterial.keywords}}" wx:key="*this">
                        {{item}}
                      </text>
                    </text>
                  </view>
                </block>
              </scroll-view>

              <view class="back-footer">
                <view class="level-dots">
                  <view wx:for="{{[1,2,3]}}" wx:key="*this"
                        class="dot {{item <= currentMaterial.memoryLevel ? 'dot-active' : ''}}"></view>
                </view>
                <text class="source-text">æ¥æºï¼š{{currentMaterial.source}}</text>
              </view>
            </view>

          </view>
        </view>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <view class="bottom-bar">
          <button class="btn-fail" data-action="fail" bindtap="handleMemoryAction">è¿˜æ²¡è®°ä½</button>
          <text class="progress-text">{{currentIndex + 1}} / {{reviewList.length}}</text>
          <button class="btn-pass" data-action="pass" bindtap="handleMemoryAction">æŒæ¡äº†</button>
        </view>
      </block>

      <!-- ç©ºçŠ¶æ€ -->
      <block wx:else>
        <view class="empty">
          <text class="empty-icon">ğŸ‰</text>
          <text class="empty-title">æœ¬é˜¶æ®µä»»åŠ¡å·²å®Œæˆ</text>
          <text class="empty-sub">å½“å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„ç´ æ</text>
          <button class="restart-btn" bindtap="restartReview">é‡æ–°å¼€å§‹ä¸€è½®</button>
        </view>
      </block>
    </view>
    </view>
  </view>

  <!-- è®¾ç½®å¼¹å±‚ -->
  <view class="overlay" wx:if="{{showSettings}}" bindtap="toggleSettings">
    <view class="panel" catchtap="true">
      <view class="panel-header">
        <text class="panel-title">èƒŒè¯µä¸æµ‹éªŒè®¾ç½®</text>
        <text class="panel-close" bindtap="toggleSettings">Ã—</text>
      </view>

      <scroll-view scroll-y="true" class="panel-body">
        <view class="panel-card">
          <view class="panel-card-title">æœ¬å‘¨å·²å¤ä¹  Â· {{weekReviewCount}} æ¡</view>
          <view class="panel-progress">
            <view class="panel-progress-inner" style="width: {{weekReviewCount > 0 ? Math.min(weekReviewCount / 15 * 100, 100) : 0}}%;"></view>
          </view>
          <text class="panel-card-sub" bindtap="goToMe">è¯¦ç»†æ€»è§ˆè¯·å‰å¾€ã€æˆ‘çš„Â·å­¦ä¹ æŠ¥å‘Šã€‘</text>
        </view>

        <view class="setting-block">
          <text class="setting-label">èƒŒè¯µèŒƒå›´</text>
          <view class="setting-tags">
            <view wx:for="{{categories}}" wx:key="*this"
                  class="setting-tag {{currentCategory === item ? 'setting-tag-active' : ''}}"
                  data-cat="{{item}}" bindtap="switchCategory">
              {{item}}
            </view>
          </view>
        </view>

        <view class="setting-block">
          <text class="setting-label">éšæœºé¡ºåº</text>
          <switch checked="{{shuffleEnabled}}" bindchange="toggleShuffle" color="#5A7D9A"/>
        </view>
      </scroll-view>

      <view class="panel-footer">
        <button class="panel-btn" bindtap="toggleSettings">ä¿å­˜å¹¶è¿”å›</button>
      </view>
    </view>
  </view>

</view>
