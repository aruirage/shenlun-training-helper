<!--pages/materials/index.wxml - ä¸‰æ ç´ ææµè§ˆ-->

<!-- iPad ä¸‰æ å¸ƒå±€ -->
<view class="materials-root" wx:if="{{isPad}}">
  <view class="pad-layout">
    
    <!-- å·¦ä¾§ï¼šæ ‘çŠ¶å¯¼èˆª -->
    <view class="pad-col pad-nav">
      <view class="nav-header">
        <view class="nav-logo">ğŸ“š</view>
        <text class="nav-title">ç´ æåº“ç›®å½•</text>
      </view>
      
      <!-- é¢†åŸŸå¯¼èˆªæ ‘ -->
      <view class="nav-tree">
        <view class="nav-group">
          <view class="nav-group-header" bindtap="toggleNavItem" data-name="æ°‘ç”Ÿ">
            <text class="nav-group-title">æ°‘ç”Ÿæ²»ç†</text>
            <text class="nav-expand-icon">{{expandedNavItems.indexOf('æ°‘ç”Ÿ') > -1 ? 'â–¼' : 'â–¶'}}</text>
          </view>
          <view class="nav-group-children" wx:if="{{expandedNavItems.indexOf('æ°‘ç”Ÿ') > -1}}">
            <view class="nav-child-item {{selectedPolicy === 'ä¹¡æ‘æŒ¯å…´' ? 'active' : ''}}" bindtap="onPolicyNavTap" data-policy="ä¹¡æ‘æŒ¯å…´">ä¹¡æ‘æŒ¯å…´</view>
            <view class="nav-child-item {{selectedPolicy === 'å…±åŒå¯Œè£•' ? 'active' : ''}}" bindtap="onPolicyNavTap" data-policy="å…±åŒå¯Œè£•">å…±åŒå¯Œè£•</view>
            <view class="nav-child-item {{selectedSubDirection === 'ç¤¾ä¼šæ²»ç†' ? 'active' : ''}}" bindtap="onSubDirectionNavTap" data-sub="ç¤¾ä¼šæ²»ç†">ç¤¾ä¼šæ²»ç†</view>
          </view>
        </view>

        <view class="nav-group">
          <view class="nav-group-header" bindtap="toggleNavItem" data-name="ç§‘æŠ€">
            <text class="nav-group-title">ç§‘æŠ€åˆ›æ–°</text>
            <text class="nav-expand-icon">{{expandedNavItems.indexOf('ç§‘æŠ€') > -1 ? 'â–¼' : 'â–¶'}}</text>
          </view>
          <view class="nav-group-children" wx:if="{{expandedNavItems.indexOf('ç§‘æŠ€') > -1}}">
            <view class="nav-child-item {{selectedPolicy === 'æ•°å­—æ”¿åºœ' ? 'active' : ''}}" bindtap="onPolicyNavTap" data-policy="æ•°å­—æ”¿åºœ">æ•°å­—æ”¿åºœ</view>
            <view class="nav-child-item {{selectedSubDirection === 'äººå·¥æ™ºèƒ½' ? 'active' : ''}}" bindtap="onSubDirectionNavTap" data-sub="äººå·¥æ™ºèƒ½">äººå·¥æ™ºèƒ½</view>
            <view class="nav-child-item {{selectedSubDirection === 'æ–°è´¨ç”Ÿäº§åŠ›' ? 'active' : ''}}" bindtap="onSubDirectionNavTap" data-sub="æ–°è´¨ç”Ÿäº§åŠ›">æ–°è´¨ç”Ÿäº§åŠ›</view>
          </view>
        </view>

        <view class="nav-group">
          <view class="nav-group-header" bindtap="toggleNavItem" data-name="ç”Ÿæ€">
            <text class="nav-group-title">ç”Ÿæ€ç¯å¢ƒ</text>
            <text class="nav-expand-icon">{{expandedNavItems.indexOf('ç”Ÿæ€') > -1 ? 'â–¼' : 'â–¶'}}</text>
          </view>
          <view class="nav-group-children" wx:if="{{expandedNavItems.indexOf('ç”Ÿæ€') > -1}}">
            <view class="nav-child-item {{selectedPolicy === 'ç”Ÿæ€ä¿æŠ¤' ? 'active' : ''}}" bindtap="onPolicyNavTap" data-policy="ç”Ÿæ€ä¿æŠ¤">ç”Ÿæ€ä¿æŠ¤</view>
            <view class="nav-child-item {{selectedSubDirection === 'ç»¿è‰²å‘å±•' ? 'active' : ''}}" bindtap="onSubDirectionNavTap" data-sub="ç»¿è‰²å‘å±•">ç»¿è‰²å‘å±•</view>
            <view class="nav-child-item {{selectedSubDirection === 'ç¾ä¸½ä¸­å›½' ? 'active' : ''}}" bindtap="onSubDirectionNavTap" data-sub="ç¾ä¸½ä¸­å›½">ç¾ä¸½ä¸­å›½</view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¸­é—´ï¼šåˆ—è¡¨åŒº -->
    <view class="pad-col pad-list">
      <!-- é¡¶éƒ¨ï¼šæ ‡é¢˜ + æœç´¢ -->
      <view class="list-header">
        <view class="header-top">
          <text class="header-title">ç´ ææµè§ˆ</text>
          <view class="search-box">
            <text class="search-icon">ğŸ”</text>
            <input type="text" class="search-input" placeholder="æœç´¢å…³é”®è¯..." value="{{searchKeyword}}" bindinput="onSearchInput" bindconfirm="performSearch" />
          </view>
        </view>

        <!-- ç­›é€‰ chips -->
        <view class="filter-chips" wx:if="{{selectedChips.length > 0}}">
          <view class="chip" wx:for="{{selectedChips}}" wx:key="*this">
            {{item}}
            <text class="chip-close" bindtap="removeChip" data-value="{{item}}">Ã—</text>
          </view>
        </view>

        <!-- ç±»å‹ Tabs -->
        <view class="type-tabs-row">
          <view class="tab-item {{currentTypeIndex === index ? 'active' : ''}}" wx:for="{{typeList}}" wx:key="index" bindtap="onTypeNavChange" data-index="{{index}}">
            {{item}}
          </view>
        </view>
      </view>

      <!-- ç´ æå¡ç‰‡åˆ—è¡¨ -->
      <view class="materials-list-scroll">
        <view class="material-card" wx:for="{{filteredMaterials}}" wx:key="_id" bindtap="onMaterialTap" data-id="{{item._id}}">
          <view class="card-header">
            <text class="card-title">{{item.title}}</text>
            <view class="card-type-badge {{item.typeClass}}">{{item.typeShort}}</view>
          </view>
          <view class="card-content">{{item.content}}</view>
          <view class="card-footer">
            <view class="card-meta">
              <text class="meta-source">{{item.displaySource}}</text>
              <text class="meta-date">{{item.displayDate}}</text>
            </view>
            <view class="card-tag">{{item.policyDirection || item.macroField}}</view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{filteredMaterials.length === 0 && !isLoading}}">
          <text class="empty-icon">ğŸ“­</text>
          <text class="empty-text">æš‚æ— æ­¤ç±»ç´ æ</text>
        </view>

        <!-- åŠ è½½ä¸­ -->
        <view class="loading" wx:if="{{isLoading}}">
          <text>åŠ è½½ä¸­...</text>
        </view>
      </view>
    </view>

    <!-- å³ä¾§ï¼šè¯¦æƒ…åŒº -->
    <view class="pad-col pad-detail">
      <view class="detail-header">
        <text class="detail-icon">ğŸ“„</text>
        <text class="detail-subtitle">MATERIAL DETAIL</text>
      </view>

      <view wx:if="{{selectedMaterial}}" class="detail-body">
        <!-- ç´ ææ­£æ–‡ -->
        <view class="detail-section">
          <view class="detail-label">ç´ ææ­£æ–‡</view>
          <view class="detail-content-text">"{{selectedMaterial.content}}"</view>
        </view>

        <!-- æ ¸å¿ƒæ ‡ç­¾ -->
        <view class="detail-section">
          <view class="detail-label">æ ¸å¿ƒæ ‡ç­¾</view>
          <view class="detail-tags">
            <view class="detail-tag" wx:if="{{selectedMaterial.macroField}}">{{selectedMaterial.macroField}}</view>
            <view class="detail-tag" wx:if="{{selectedMaterial.policyDirection}}">{{selectedMaterial.policyDirection}}</view>
            <view class="detail-tag" wx:for="{{selectedMaterial.tags || []}}" wx:key="*this">{{item}}</view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="detail-actions">
          <view class="btn-bookmark" bindtap="addToMemory">
            <text class="btn-icon">ğŸ”–</text>
            <text>åŠ å…¥èƒŒè¯µæœ¬</text>
          </view>
        </view>

        <!-- AI å»ºè®® -->
        <view class="detail-hint">
          <text class="hint-icon">ğŸ’¡</text>
          <view class="hint-text">æ­¤ç´ æå‡ºè‡ªã€Š{{selectedMaterial.title}}ã€‹ï¼Œå»ºè®®ç”¨äºç”³è®ºå¯¹ç­–æ®µè½ã€‚</view>
        </view>
      </view>

      <view wx:else class="detail-empty">
        <text>ğŸ‘ˆ ä»å·¦ä¾§é€‰æ‹©ç´ ææŸ¥çœ‹è¯¦æƒ…</text>
      </view>
    </view>
  </view>
</view>

<!-- æ‰‹æœºå•åˆ—å¸ƒå±€ -->
<view class="materials-root materials-container phone-layout" wx:else>
  <!-- é¡¶éƒ¨è¿‡æ»¤æ¡ -->
  <view class="filter-section">
    <!-- ç¬¬ä¸€è¡Œï¼šå®è§‚é¢†åŸŸ + æ”¿ç­–æ–¹å‘ -->
    <view class="filter-row">
      <view class="filter-item">
        <text class="filter-label">é¢†åŸŸï¼š</text>
        <picker class="picker" mode="selector" range="{{macroFieldList}}" value="{{selectedMacroFieldIndex}}" bindchange="onMacroFieldChange">
          <view class="picker-text">{{selectedMacroField}}</view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">æ”¿ç­–ï¼š</text>
        <picker class="picker" mode="selector" range="{{policyList}}" value="{{selectedPolicyIndex}}" bindchange="onPolicyChange">
          <view class="picker-text">{{selectedPolicy}}</view>
        </picker>
      </view>
    </view>
    
    <!-- ç¬¬äºŒè¡Œï¼šåˆ†è®ºç‚¹æ–¹å‘ + ç±»å‹ Tab -->
    <view class="filter-row">
      <view class="filter-item">
        <text class="filter-label">åˆ†è®ºç‚¹ï¼š</text>
        <picker class="picker" mode="selector" range="{{subDirectionList}}" value="{{selectedSubDirectionIndex}}" bindchange="onSubDirectionChange">
          <view class="picker-text">{{selectedSubDirection}}</view>
        </picker>
      </view>
    </view>

    <!-- ç±»å‹ Tab -->
    <view class="type-tabs">
      <view 
        class="tab-item {{currentTypeIndex === index ? 'active' : ''}}" 
        wx:for="{{typeList}}" 
        wx:key="index"
        data-index="{{index}}"
        bindtap="onTypeChange">
        {{item}}
      </view>
    </view>
  </view>

  <!-- ç¤ºä¾‹ç´ æå¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -->
  <view class="sample-material-section" wx:if="{{sampleMaterial}}">
    <view class="sample-header">
      <text class="sample-label">ğŸ’¡ æ¥è‡ªé¦–é¡µçƒ­ç‚¹ç¤ºä¾‹</text>
    </view>
    <view class="sample-card">
      <view class="sample-title">{{sampleMaterial.title}}</view>
      <view class="sample-desc">{{sampleMaterial.content}}</view>
      <view class="sample-footer">
        <view class="sample-btn" bindtap="onAddMaterialTap" data-material="{{sampleMaterial}}" data-topic="é¦–é¡µç¤ºä¾‹">+ åŠ å…¥ç´ æåº“</view>
      </view>
    </view>
  </view>

  <!-- ç´ æåˆ—è¡¨ -->
  <view class="materials-list">
    <view class="material-block {{item.selected ? 'selected' : ''}}" 
          wx:for="{{filteredMaterials}}" 
          wx:key="_id"
          bindtap="onMaterialTap"
          data-id="{{item._id}}">
      
      <!-- å·¦ä¾§å¤é€‰æ¡† -->
      <view class="block-checkbox" catchtap="toggleMaterial" data-id="{{item._id}}">
        <text wx:if="{{item.selected}}">âœ“</text>
      </view>

      <!-- å·¦ä¾§å½©è‰²å›¾æ ‡ -->
      <view class="block-icon {{item.typeClass}}">
        {{item.typeShort}}
      </view>

      <!-- ä¸­é—´ä¸»ä½“å†…å®¹ -->
      <view class="block-main">
        <view class="block-title">{{item.title}}</view>
        <view class="block-desc">{{item.content}}</view>
      </view>

      <!-- å³ä¾§æ ‡ç­¾ç»„ -->
      <view class="block-tags">
        <!-- å®è§‚é¢†åŸŸæ ‡ç­¾ -->
        <view class="tag tag-macro-{{item.macroFieldClass}}" wx:if="{{item.macroField}}">
          {{item.macroField}}
        </view>

        <!-- æ”¿ç­–æ–¹å‘æ ‡ç­¾ -->
        <view class="tag tag-policy" wx:if="{{item.policyDirection}}">
          {{item.policyDirection}}
        </view>

        <!-- åˆ†è®ºç‚¹æ ‡ç­¾ -->
        <view class="tag tag-sub" wx:if="{{item.subDirection}}">
          {{item.subDirection}}
        </view>

        <!-- ç±»å‹æ ‡ç­¾ -->
        <view class="tag tag-type-{{item.typeClass}}" wx:if="{{item.type}}">
          {{item.type}}
        </view>
      </view>
    </view>

    <!-- æ— æ•°æ®æç¤º -->
    <view class="empty-state" wx:if="{{filteredMaterials.length === 0 && !isLoading}}">
      <text>ğŸ“­ æš‚æ— ç´ æ</text>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading" wx:if="{{isLoading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- ä¸‹æ‹‰åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && !isLoading}}" bindtap="loadMoreMaterials">
      åŠ è½½æ›´å¤š
    </view>

    <!-- å·²åŠ è½½å…¨éƒ¨æç¤º -->
    <view class="no-more" wx:if="{{!hasMore && filteredMaterials.length > 0}}">
      <text>å·²åŠ è½½å…¨éƒ¨ (å…± {{filteredMaterials.length}} æ¡)</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ ï¼ˆå›ºå®šï¼‰ -->
  <view class="bottom-bar">
    <view class="selected-info">
      å·²é€‰ <text class="count">{{selectedMaterials.length}}</text> æ¡
    </view>
    <view class="action-btn {{selectedMaterials.length === 0 ? 'disabled' : ''}}" bindtap="goToDiy">
      å» DIY â†’
    </view>
  </view>
  
  <!-- åº•éƒ¨å ä½ï¼Œé˜²æ­¢å†…å®¹è¢«åº•éƒ¨æ é®æŒ¡ -->
  <view class="bottom-placeholder"></view>

  <!-- æ ‡ç­¾ç¼–è¾‘æŠ½å±‰ -->
  <view class="drawer {{showTagDrawer ? 'show' : ''}}" bindtap="closeTagDrawer">
    <view class="drawer-content" catchtap>
      <view class="drawer-header">
        <text>è°ƒæ•´ç´ ææ ‡ç­¾</text>
        <text class="close-btn" bindtap="closeTagDrawer">âœ•</text>
      </view>
    
      <view class="drawer-body">
        <view class="drawer-hint">
          ä»…è°ƒæ•´æœ¬æ¡ç´ æçš„æ ‡ç­¾ï¼Œä¸å½±å“åŒåˆ†è®ºç‚¹ä¸‹å…¶ä»–ç´ æ
        </view>
      
        <view class="editing-material-title">
          {{editingMaterial.title}}
        </view>
      
        <view class="drawer-item">
          <text class="item-label">å®è§‚é¢†åŸŸ</text>
          <picker class="item-picker" mode="selector" range="{{editMacroFieldList}}" value="{{editMacroField}}" bindchange="onEditMacroFieldChange">
            <view class="picker-display">{{editMacroFieldList[editMacroField]}}</view>
          </picker>
        </view>
      
        <view class="drawer-item">
          <text class="item-label">æ”¿ç­–æ–¹å‘</text>
          <picker class="item-picker" mode="selector" range="{{editPolicyList}}" value="{{editPolicyDirection}}" bindchange="onEditPolicyChange">
            <view class="picker-display">{{editPolicyList[editPolicyDirection]}}</view>
          </picker>
        </view>
      
        <view class="drawer-item">
          <text class="item-label">åˆ†è®ºç‚¹æ–¹å‘</text>
          <picker class="item-picker" mode="selector" range="{{editSubDirectionList}}" value="{{editSubDirection}}" bindchange="onEditSubDirectionChange">
            <view class="picker-display">{{editSubDirectionList[editSubDirection]}}</view>
          </picker>
        </view>
      </view>
    
      <view class="drawer-footer">
        <view class="btn btn-cancel" bindtap="closeTagDrawer">å–æ¶ˆ</view>
        <view class="btn btn-submit {{isUpdatingTags ? 'loading' : ''}}" bindtap="submitTagUpdate">
          {{isUpdatingTags ? 'æ›´æ–°ä¸­...' : 'ç¡®è®¤æ›´æ–°'}}
        </view>
      </view>
    </view>
  </view>
</view>
