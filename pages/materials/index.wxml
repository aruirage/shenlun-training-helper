<view class="container">
  <!-- ä¾§è¾¹å¯¼èˆªæ  -->
  <sidebar-nav activeNav="ç´ æåº“" userAvatar="{{userAvatar}}"></sidebar-nav>

  <!-- ä¸»å†…å®¹åŒº -->
  <view class="main-content">
    <!-- é¡¶éƒ¨ Header -->
    <view class="header">
      <view class="header-left">
        <text class="title">ç´ æåº“</text>
        <text class="subtitle">ç®¡ç†ä½ çš„ä¸“å±å†™ä½œç´ æï¼Œä¸€é”®å¯¼å…¥èƒŒè¯µæœ¬ã€‚</text>
      </view>
      <view class="header-right">
        <view class="search-bar">
          <text class="search-icon">ğŸ”</text>
          <input 
            type="text" 
            placeholder="æ£€ç´¢ç´ æ..." 
            value="{{searchKeyword}}" 
            bindinput="onSearchInput"
          />
        </view>
        <view class="add-btn" bindtap="addMaterial">
          <text class="plus-icon">+</text>
        </view>
      </view>
    </view>

    <!-- åˆ†ç±» Tabs -->
    <view class="tabs-bar">
      <view class="tabs-left">
        <view 
          class="tab-item {{activeTabIndex === index ? 'active' : ''}}" 
          wx:for="{{tabs}}" 
          wx:key="index"
          bindtap="onTabTap"
          data-index="{{index}}"
        >
          {{item}}
          <view class="active-line" wx:if="{{activeTabIndex === index}}"></view>
        </view>
      </view>
      <view class="filter-btn" bindtap="onFilterTap">
        <text class="filter-icon">â–½</text>
        <text>ç­›é€‰ä¸»é¢˜</text>
      </view>
    </view>

    <!-- ç´ æåˆ—è¡¨ Grid -->
    <scroll-view scroll-y class="materials-grid-scroll">
      <view class="materials-grid">
        <view 
          class="material-card" 
          wx:for="{{filteredMaterials}}" 
          wx:key="id"
          bindtap="onMaterialTap"
          data-id="{{item.id}}"
        >
          <view class="card-header">
            <view class="category-text">{{item.category}}</view>
            <view class="type-tag-simple">{{item.type}}</view>
          </view>
          <view class="card-body">
            <text class="content-text">{{item.content}}</text>
          </view>
          <view class="card-footer">
            <view class="footer-left">
              <text class="source-text">{{item.source}}</text>
              <text class="date-text">{{item.date}}</text>
            </view>
            <view class="footer-right">
              <view class="proficiency-indicator">
                <view 
                  class="dot {{index < (item.proficiency / 20) ? 'active' : ''}}" 
                  wx:for="{{[0,1,2,3,4]}}" 
                  wx:key="*this"
                ></view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{filteredMaterials.length === 0}}">
        <text>æš‚æ— ç›¸å…³ç´ æ</text>
      </view>
    </scroll-view>
  </view>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showDetail}}" bindtap="onCloseModal">
    <view class="modal-content detail-modal" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">{{selectedMaterial.type}}è¯¦æƒ…</text>
        <view class="close-btn" bindtap="onCloseModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="detail-category">{{selectedMaterial.category}}</view>
        
        <!-- æ¡ˆä¾‹ç±»å‹æ˜¾ç¤ºä¸‰ä¸ªéƒ¨åˆ† -->
        <block wx:if="{{selectedMaterial.type === 'æ¡ˆä¾‹'}}">
          <view class="case-section">
            <view class="case-section-title">æ¡ˆä¾‹èƒŒæ™¯</view>
            <view class="case-section-content">{{selectedMaterial.background || 'æš‚æ— èƒŒæ™¯ä¿¡æ¯'}}</view>
          </view>
          <view class="case-section">
            <view class="case-section-title">å…·ä½“åšæ³•</view>
            <view class="case-section-content">{{selectedMaterial.actions || 'æš‚æ— å…·ä½“åšæ³•'}}</view>
          </view>
          <view class="case-section">
            <view class="case-section-title">å–å¾—æˆæ•ˆ</view>
            <view class="case-section-content">{{selectedMaterial.results || 'æš‚æ— æˆæ•ˆä¿¡æ¯'}}</view>
          </view>
        </block>
        
        <!-- å…¶ä»–ç±»å‹æ˜¾ç¤ºå…¨æ–‡ -->
        <view class="detail-content" wx:else>
          <text class="serif-text">{{selectedMaterial.fullContent}}</text>
        </view>

        <view class="detail-meta" wx:if="{{selectedMaterial.link}}">
          <text class="meta-label">åŸæ–‡é“¾æ¥ï¼š</text>
          <text class="meta-link" bindtap="onOpenLink" data-link="{{selectedMaterial.link}}">ç‚¹å‡»è·³è½¬åŸæ–‡</text>
        </view>
        <view class="detail-footer">
          <text>æ¥æºï¼š{{selectedMaterial.source}}</text>
          <text>æ—¶é—´ï¼š{{selectedMaterial.date}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯é¢˜ç­›é€‰å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showFilterModal}}" bindtap="onCloseModal">
    <view class="modal-content filter-modal" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">ç­›é€‰è¯é¢˜</text>
        <view class="close-btn" bindtap="onCloseModal">Ã—</view>
      </view>
      <scroll-view scroll-y class="modal-body">
        <view class="filter-section">
          <view class="filter-item {{selectedCategory === 'å…¨éƒ¨' ? 'active' : ''}}" bindtap="onSelectCategory" data-cat="å…¨éƒ¨">å…¨éƒ¨è¯é¢˜</view>
        </view>
        <view class="filter-group" wx:for="{{filterCategories}}" wx:key="name">
          <view class="group-title">{{item.name}}</view>
          <view class="group-items">
            <view 
              class="filter-item {{selectedCategory === sub ? 'active' : ''}}" 
              wx:for="{{item.sub}}" 
              wx:for-item="sub" 
              wx:key="*this"
              bindtap="onSelectCategory"
              data-cat="{{sub}}"
            >
              {{sub}}
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- æ·»åŠ ç´ æå¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showAddModal}}" bindtap="onCloseModal">
    <view class="modal-content add-modal" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">æ·»åŠ ä¸ªäººç´ æ</text>
        <view class="close-btn" bindtap="onCloseModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">åˆ†ç±»</text>
          <picker 
            bindchange="onInputNew" 
            data-field="type" 
            value="{{newMaterial.type}}" 
            range="{{tabs}}"
          >
            <view class="picker-val">{{newMaterial.type || 'è¯·é€‰æ‹©åˆ†ç±»'}}</view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">ä¸»é¢˜/æ ‡ç­¾</text>
          <input 
            placeholder="å¦‚ï¼šæ•°å­—ç»æµ, ç§‘æŠ€" 
            value="{{newMaterial.category}}" 
            bindinput="onInputNew" 
            data-field="category"
          />
        </view>
        <view class="form-item">
          <text class="label">å†…å®¹</text>
          <textarea 
            placeholder="è¯·è¾“å…¥ç´ æå†…å®¹..." 
            value="{{newMaterial.content}}" 
            bindinput="onInputNew" 
            data-field="content"
          ></textarea>
        </view>
        <button class="confirm-btn" bindtap="onConfirmAdd">ç¡®è®¤æ·»åŠ </button>
      </view>
    </view>
  </view>
</view>
